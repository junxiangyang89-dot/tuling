<div class="turing-machine-container">
  <app-shared-toast></app-shared-toast>
  <!-- 顶部菜单栏 -->
  <div class="top-menu">
    <div class="left-side">
      <button class="sidebar-toggle" (click)="toggleSidebar()">
        {{ showSidebar ? '关闭菜单' : '图灵机列表' }}
      </button>
      <button class="welcome-button" (click)="navigateToWelcome()">切换模式</button>
      <button class="ai-chat" (click)="toggleChat()">AI 助手</button>
      <div class="chat-overlay" *ngIf="showChat">
        <div class="chat-dialog" (click)="$event.stopPropagation()">
          <div class="chat-header">
            <h3>AI 助手</h3>
            <button class="close-btn" (click)="toggleChat()">✕</button>
          </div>
          <app-chat-assistant></app-chat-assistant>
        </div>
      </div>
  <button class="help-button" (click)="navigateToHelp()">用户手册</button>
  <button class="help-button" (click)="toggleHelp()">帮助</button>
    </div>

    <div class="center">
      <div *ngIf="!isEditingName && machine">
        <h2 *ngIf="machine?.name">{{ machine?.name }}</h2>
        <button class="rename-inline" title="重命名" (click)="startEditName()">重命名</button>
      </div>
      <div *ngIf="isEditingName && machine" class="rename-form-inline">
        <input type="text" [(ngModel)]="editingName" placeholder="输入新名称" class="inline-name-input" />
        <input type="text" [(ngModel)]="editingDescription" placeholder="输入描述（可选）" class="inline-desc-input" />
        <button class="save-inline" (click)="saveNameEdit()">保存</button>
        <button class="cancel-inline" (click)="cancelEditName()">取消</button>
      </div>
    </div>

    <div class="right-side">
      <span class="username">用户: {{ username }}</span>
      <button class="login-btn" (click)="to_login()">返回登录界面</button>
      <button class="logout-button" (click)="logout()">退出登录</button>
    </div>
  </div>

  <!-- 主内容区域 -->
  <div class="main-content" *ngIf="hasMachine">

    <div *ngIf="currentMode !== 'learning-mode'" class="panel add-rule-panel">

    </div>
    <!-- 上部区域: 纸带和控制面板 -->
    <div class="tape-control-container">
      <app-tape-display
        [tape]="visible"
        (cellClick)="onCellClick($event)">
      </app-tape-display>

      <app-input-handler
        [currentState]="currentState"
        [currentSteps]="steps"
        [acceptState]="'qAccept'"
        (tapeUpdated)="onTapeUpdated($event)">
      </app-input-handler>

      <app-control-panel
        (moveLeft)="moveLeft()"
        (moveRight)="moveRight()"
        (writeSymbol)="onWriteSymbol($event)">
      </app-control-panel>

      <app-simulation
        [isRunning]="isRunning"
        (start)="onStart()"
        (pause)="onPause()"
        (step)="onStep()"
        (reset)="onReset()">
      </app-simulation>
    </div>

    <!-- 下部区域: 聊天室、转换规则和规则编辑 -->
    <div class="chat-rules-container">
      <!-- 左侧: 聊天室 -->
      <div class="panel chat-panel">
        <h3>聊天室</h3>
        <app-chat-room [sender]="username"></app-chat-room>
      </div>

      <!-- 中间: 转换规则 -->
      <div class="panel rules-panel">
        <h3>转换规则</h3>
        <app-transition-rules
          [rulename]="rulename"
          [rules]="transitionRules"
          [ruleNames]="allRuleNames"
          [currentMode]="currentMode"
          (clearRulesClicked)="clearRulesFromChild()"
          (saveRulesClicked)="saveRulesFromChild()"
          (newRuleCreated)="onNewRuleCreated($event)"
          (loadRulesRequested)="loadRulesFromDB($event)"
          (deleteRuleClicked)="deleteRule($event)"
          (deleteSampleRulesClicked)="deleteSampleRules()"
          (clearAllRulesClicked)="clearAllRules()">
        </app-transition-rules>

        <p class="rules-count">规则数量：{{ transitionRules.length }}</p>

        <app-conflict-dialog
          *ngIf="showConflictDialog"
          [existingRule]="conflictingRule"
          [newRule]="pendingRule"
          (confirm)="confirmOverride()"
          (cancel)="cancelOverride()">
        </app-conflict-dialog>
      </div>

      <!-- 右侧: 添加规则 -->
      <div *ngIf="currentMode !== 'learning-mode'" class="panel add-rule-panel">
        <h3>添加规则</h3>
        <app-add-rule
          [availableStates]="availableStates"
          (addRule)="onAddRule($event)"
          (addCustomState)="onAddState($event)">
        </app-add-rule>
      </div>
    </div>

    <!-- 状态编辑器区域 -->
    <div class="state-editor-section">
      <div class="state-editor-header">
        <button class="state-editor-toggle" (click)="toggleStateEditor()">
          {{ showStateEditor ? '隐藏状态图' : '显示状态图编辑器' }}
        </button>
      </div>
      <div *ngIf="showStateEditor" class="state-editor-container" #stateEditorContainer>
        <app-state-editor
          *ngIf="showStateEditor"
          [currentMode]="currentMode"
          [currentState]="currentState"
          [transitionRules]="transitionRules"
          [availableStates]="availableStates"
          (addState)="onAddState($event)"
          (addRule)="onAddRule($event)">
        </app-state-editor>
      </div>
    </div>
  </div>

  <!-- 无图灵机选择时的提示 -->
  <div *ngIf="!hasMachine" class="no-machine-message">
    <h3>请先选择或创建一个图灵机</h3>
    <p>点击左上角的"图灵机列表"按钮选择或创建一个图灵机</p>
  </div>

  <!-- 图灵机侧边栏 -->
  <div class="sidebar" [class.active]="showSidebar">
    <div class="sidebar-header">
      <h3>图灵机管理</h3>
      <div>
  <!-- 新建图灵机：在非自由模式下视觉上显示为禁用但仍可点击以显示提示 -->
  <button class="create-button" [class.disabled]="currentMode !== 'free-mode'" (click)="onCreateButtonClicked()">新建图灵机</button>
        <button class="close-button" (click)="toggleSidebar()" title="关闭菜单">✕</button>
      </div>
    </div>

    <!-- 图灵机列表 -->
    <div class="machine-list">
      <div *ngIf="machines.length === 0" class="empty-list">
        暂无图灵机，请创建一个新的。
        <p>调试信息: {{debugInfo}}</p>
      </div>
      <div *ngFor="let machine of machines"
           class="machine-item"
           (click)="selectMachine(machine)">
        <h4>{{ machine.name || '未命名图灵机' }}</h4>
        <p *ngIf="machine.description">{{ machine.description }}</p>
        <p *ngIf="machine.createTime">创建时间: {{ machine.createTime | date:'short' }}</p>
        <p>图灵机ID: {{ machine.id }}</p>
        <div class="status" [class.completed]="machine.isCompleted">
          {{ machine.isCompleted ? '已完成' : '未完成' }}
        </div>
        <button (click)="deleteMachine(machine.id); $event.stopPropagation()">删除</button>
      </div>
    </div>
  </div>

  <!-- 创建图灵机表单 (弹出层) -->
  <div class="create-form-overlay" *ngIf="showCreateForm" (click)="toggleCreateForm()">
    <div class="create-form" (click)="$event.stopPropagation()">
      <h3>创建新图灵机</h3>
      <div class="form-group">
        <label for="name">名称</label>
        <input type="text" id="name" [(ngModel)]="newMachine.name" placeholder="输入图灵机名称">
      </div>
      <div class="form-group">
        <label for="description">描述</label>
        <textarea id="description" [(ngModel)]="newMachine.description" placeholder="输入图灵机描述（可选）"></textarea>
      </div>
      <div class="form-group">
        <label for="tape">初始纸带</label>
        <input type="text" id="tape" [(ngModel)]="newMachine.configuration.tape" placeholder="输入初始纸带内容">
      </div>
      <div class="form-actions">
        <button (click)="toggleCreateForm()">取消</button>
        <button class="primary" (click)="createMachine()">创建</button>
      </div>
    </div>
  </div>

      <!-- 教程已移入“帮助”弹窗，页面底部区域已移除以释放空间 -->
      <div class="chat-overlay help" *ngIf="showHelp" (click)="toggleHelp()"
           (keydown.escape)="toggleHelp()" tabindex="0" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
        <div class="chat-dialog help-dialog" (click)="$event.stopPropagation()">
          <div class="chat-header">
            <h3 id="helpTitle">帮助</h3>
            <button class="close-btn" (click)="toggleHelp()" aria-label="关闭 帮助">✕</button>
          </div>
          <div class="help-content">
            <div class="tutorial-grid">
              <div class="tutorial-column">
                <h3>试着运行图灵机</h3>
                <p><strong>运行</strong>运行机器以查看其实际行为。您可以随时<strong>单步</strong>或<strong>暂停</strong>，或<strong>重置</strong>以重新开始。</p>
                <p><strong>左移/右移</strong>向左向右移动一个单元格。</p>
                <p><strong>0 </strong> <strong>1 </strong> <strong>write </strong>选中纸带的某一个格，点击0或1，再点击write，写入您想要的数字。</p>
                <p>可以<strong>手动</strong>输入序列，也可以<strong>点击纸带</strong>修改某一格的数字</p>
                <h3>试着聊天</h3>
                <p>可以和其他小伙伴快乐的交流</p>
                <h3>转换规则</h3>
                <p>点击<strong>下拉框</strong>查看可选规则</p>
                <p>点击按钮增加/删除规则</p>
                <h3>添加规则</h3>
                <p>自定义您的新规则，加入当前规则集！</p>
              </div>

              <div *ngIf="currentMode !== 'learning-mode'" class="tutorial-column">
                <h3>制作您自己的图灵机</h3>
                <p>点击<strong>图灵机列表</strong>，点击<strong>新建图灵机</strong></p>
                <p>在转换规则点击<strong>新建</strong>创建新的规则集</p>
                <p>在添加规则中添加您想要的规则</p>
                <ul>
                  <li>可行的读入：0,1, </li>
                  <li>可行的写入：0,1, </li>
                  <li>勾选启用写入，写入所选写符号</li>
                  <li>可行的移动方向：左移，不动，右移 </li>
                </ul>
                <p><strong>注意不要添加冲突的规则！！！</strong></p>
                <p><strong>记得点击保存，保存您新建的图灵机规则</strong></p>
              </div>
            </div>
          </div>
        </div>
      </div>

  <!-- 挑战模式测试功能 -->
  <div *ngIf="currentMode === 'challenge-mode'" class="challenge-test">
    <button (click)="toggleTestDialog()">开始挑战测试</button>
  </div>

  <!-- 测试弹窗 -->
  <div class="test-dialog-overlay" *ngIf="showTestDialog" (click)="toggleTestDialog()">
    <div class="test-dialog" (click)="$event.stopPropagation()">
      <h3>挑战测试评估</h3>

      <div class="testcase" *ngFor="let test of testCases">
        <h4>{{ test.title }}</h4>
        <p><strong>输入:</strong> {{ test.input }}</p>
        <p><strong>预期输出:</strong> {{ test.expected }}</p>
        <p><strong>用户输出:</strong> {{ test.userOutput || '（未测试）' }}</p>
        <p><strong>评估结果:</strong>
          <span *ngIf="test.evaluation !== null">
          {{ test.evaluation ? '✅ 回答正确' : '❌ 回答错误' }}
        </span>
          <span *ngIf="test.evaluation === null">尚未评估</span>
        </p>
        <button (click)="runTest(test)">测试</button>
      </div>

      <button class="close-btn" (click)="toggleTestDialog()">关闭</button>
    </div>
  </div>


</div>
